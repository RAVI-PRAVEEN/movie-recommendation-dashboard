<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TMDB Web Data Connector</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.0.js"></script>
    <script type="text/javascript">
        (function() {
            var myConnector = tableau.makeConnector();

            // Define the schema of the data to be fetched
            myConnector.getSchema = function(schemaCallback) {
                var cols = [
                    { id: "id", dataType: tableau.dataTypeEnum.int },
                    { id: "title", dataType: tableau.dataTypeEnum.string },
                    { id: "release_date", dataType: tableau.dataTypeEnum.date },
                    { id: "popularity", dataType: tableau.dataTypeEnum.float },
                    { id: "overview", dataType: tableau.dataTypeEnum.string }
                ];

                var tableSchema = {
                    id: "tmdbMovies",
                    alias: "TMDB Popular Movies",
                    columns: cols
                };

                schemaCallback([tableSchema]);
            };

            // Fetch the data from TMDB and pass it to Tableau
            myConnector.getData = function(table, doneCallback) {
                var apiKey = "0ceda3df59bfbe633e321cef09a71e8d"; // Your TMDB API key
                var url = `https://api.themoviedb.org/3/movie/popular?api_key=${apiKey}&language=en-US&page=1`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        var tableData = data.results.map(movie => ({
                            id: movie.id,
                            title: movie.title,
                            release_date: movie.release_date,
                            popularity: movie.popularity,
                            overview: movie.overview
                        }));

                        table.appendRows(tableData);
                        doneCallback();
                    })
                    .catch(error => console.error("Error fetching data:", error));
            };

            tableau.registerConnector(myConnector);

            // Add event listener to the button for initiating the data fetch
            document.querySelector("#fetchData").addEventListener("click", function() {
                tableau.connectionName = "TMDB Popular Movies";
                tableau.submit();
            });
        })();
    </script>
</head>
<body>
    <h1>TMDB Web Data Connector</h1>
    <button id="fetchData">Fetch Data from TMDB</button>
</body>
</html>
